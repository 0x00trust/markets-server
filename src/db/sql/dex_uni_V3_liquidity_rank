
With Burning as (
select sum(cast(B.amount0 as BIGNUMERIC)) sum0, sum(cast(B.amount1 as BIGNUMERIC)) sum1, token0, token1, pool
from blockchain-etl.ethereum_uniswap.UniswapV3Pool_event_Burn B, blockchain-etl.ethereum_uniswap.UniswapV3Factory_event_PoolCreated P
where B.contract_address = P.pool
group by token0, token1, pool
),
Minting as (
select sum(cast(M.amount0 as BIGNUMERIC)) sum0, sum(cast(M.amount1 as BIGNUMERIC)) sum1, token0, token1, pool
from blockchain-etl.ethereum_uniswap.UniswapV3Pool_event_Mint M, blockchain-etl.ethereum_uniswap.UniswapV3Factory_event_PoolCreated P
where M.contract_address = P.pool
group by token0, token1, pool
),
Swapping as (
select sum(cast(M.amount0 as BIGNUMERIC)) sum0, sum(cast(M.amount1 as BIGNUMERIC)) sum1, token0, token1, pool
from blockchain-etl.ethereum_uniswap.UniswapV3Pool_event_Swap M, blockchain-etl.ethereum_uniswap.UniswapV3Factory_event_PoolCreated P
where M.contract_address = P.pool
group by token0, token1, pool
),
Final as (
select (M.sum0-B.sum0+S.sum0) as sum0, (M.sum1-B.sum1+S.sum1) as sum1, M.token0, M.token1, M.pool
from Burning B, Minting M, Swapping S
where B.pool = M.pool and M.pool = S.pool
),
Final2 as (
Select sum0, token0 from Final 
UNION ALL 
Select sum1 as sum0, token1 as token0 from Final
)
Select sum(sum0) as sum0, token0 from Final2 
group by token0
