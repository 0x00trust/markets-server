with V3 as (
select S.*, P.token0, P.token1 
from blockchain-etl.ethereum_uniswap.UniswapV3Pool_event_Swap S 
,blockchain-etl.ethereum_uniswap.UniswapV3Factory_event_PoolCreated P
where S.contract_address = P.pool
and S.block_timestamp >= '2021-09-11' and S.block_timestamp < '2021-09-12'
and (P.token1 in ('0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xdac17f958d2ee523a2206206994597c13d831ec7', '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599')
    or P.token0 in ('0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xdac17f958d2ee523a2206206994597c13d831ec7', '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599'))
),
group1A as (
select sum(abs(cast(amount1 as numeric))) as USD_sum from V3
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group1B as (
select sum(abs(cast(amount0 as numeric))) as USD_sum from V3
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2A as (
select sum(abs(cast(amount0 as numeric))) as Eth_sum from V3
where token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2B as (
select sum(abs(cast(amount1 as numeric))) as Eth_sum from V3
where token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group3A as (
select sum(abs(cast(amount0 as numeric))) as Btc_sum from V3
where token0 = '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599'
and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48','0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')
),
group3B as (
select sum(abs(cast(amount1 as numeric))) as Btc_sum from V3
where token1 = '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599'
and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48','0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')
),
group2Ra as (
select sum(abs(cast(amount0 as numeric))) as USD_sum, sum(abs(cast(amount1 as numeric))) as Eth_sum  from V3 
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') 
and token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
group2Rb as (
select sum(abs(cast(amount1 as numeric))) as USD_sum, sum(abs(cast(amount0 as numeric))) as Eth_sum  from V3 
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') 
and token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
group3Rb as (
select sum(abs(cast(amount1 as numeric))) as USD_sum, sum(abs(cast(amount0 as numeric))) as Btc_sum  from V3 
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') 
and token0 = '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599'
),
rates as (
select (Rb3.USD_sum/1000000)/(Rb3.Btc_sum/100000000) as Btc_rate, ((Rb2.USD_sum+Ra2.USD_sum)/1000000)/((Ra2.Eth_sum + Rb2.Eth_sum)/1000000000000000000) as Eth_rate
from group3Rb Rb3, group2Ra Ra2, group2Rb as Rb2
)

select (A1.USD_sum + B1.USD_sum)/1000000 + (A2.Eth_sum + B2.Eth_sum)/1000000000000000000*r.Eth_rate + (A3.Btc_sum +B3.Btc_sum)/100000000*r.Btc_rate as V3_dex_volume  
from rates r, group1A A1, group1B B1, group2A A2, group2B B2, group3A A3, group3B B3


