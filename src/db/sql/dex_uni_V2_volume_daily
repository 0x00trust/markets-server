with daily as (
SELECT S.*, P.token0, P.token1 FROM blockchain-etl.ethereum_uniswap.UniswapV2Pair_event_Swap S 
, blockchain-etl.ethereum_uniswap.UniswapV2Factory_event_PairCreated P
where S.contract_address = P.pair and 
S.block_timestamp >= '2021-09-11' and S.block_timestamp < '2021-09-12'
), 
group1 as (
select amount0In, amount1Out, token0, token1 from daily
where amount0In !='0' and amount0Out ='0' and amount1Out !='0'
), 
group2 as (
select amount1In, amount0Out, token0, token1 from daily
where amount1In !='0' and amount0Out !='0' and amount1Out ='0'
),
group1A as (
select sum(cast(amount0In as numeric)) as Eth_sum from group1 
where token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2' and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
),
group1B as (
select sum(cast(amount1Out as numeric)) as Eth_sum from group1 
where token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
),
group1C as (
select sum(cast(amount0In as numeric)) as USD_sum from group1 
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group1D as (
select sum(cast(amount1Out as numeric)) as USD_sum from group1 
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group1E as (
select sum(cast(amount0In as numeric)) as USD_sum from group1 
where token0 in ('0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group1F as (
select sum(cast(amount1Out as numeric)) as USD_sum from group1 
where token1 in ('0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2A as (
select sum(cast(amount1In as numeric)) as Eth_sum from group2
where token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2' and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
),
group2B as (
select sum(cast(amount0Out as numeric)) as Eth_sum from group2
where token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2' and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
),
group2C as (
select sum(cast(amount1In as numeric)) as USD_sum from group2
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2D as (
select sum(cast(amount0Out as numeric)) as USD_sum from group2
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2E as (
select sum(cast(amount1In as numeric)) as USD_sum from group2
where token1 in ('0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
and token0 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group2F as (
select sum(cast(amount0Out as numeric)) as USD_sum from group2
where token0 in ('0x6b175474e89094c44da98b954eedeac495271d0f', '0x57ab1ec28d129707052df4df418d58a2d46d5f51')
and token1 not in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
),
group1Rc as (
select sum(cast(amount0In as numeric)) as USD_sum, sum(cast(amount1Out as numeric)) as Eth_sum  from group1 
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') 
and token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
group1Rd as (
select sum(cast(amount1Out as numeric)) as USD_sum, sum(cast(amount0In as numeric)) as Eth_sum from group1 
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
and token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
group2RC as (
select sum(cast(amount1In as numeric)) as USD_sum, sum(cast(amount0Out as numeric)) as Eth_sum from group2
where token1 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
and token0 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
group2RD as (
select sum(cast(amount0Out as numeric)) as USD_sum, sum(cast(amount1In as numeric)) as Eth_sum from group2
where token0 in ('0xdac17f958d2ee523a2206206994597c13d831ec7', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')
and token1 = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'
),
final as (
    SELECT 
    (A1.Eth_sum+B1.Eth_sum+A2.Eth_sum+B2.Eth_sum)/1000000000000000000 as Eth_Sum, 
    (C1.USD_sum+D1.USD_sum+C2.USD_sum+D2.USD_sum)/1000000 + (E1.USD_sum+F1.USD_sum+E2.USD_sum+F2.USD_sum)/1000000000000000000 as USD_sum,
    (RC1.USD_sum + RD1.USD_sum + RC2.USD_sum + RD2.USD_sum)/1000000 as USD_rate, (RC1.Eth_sum + RD1.Eth_sum + RC2.Eth_sum + RD2.Eth_sum)/1000000000000000000 as Eth_Rate
from group1A as A1, group1B as B1, group1C as C1, group1D as D1, group1E as E1, group1F as F1, group2A as A2, group2B as B2, group2C as C2, group2D as D2, group2E as E2, group2F as F2, group1Rc as RC1, group1Rd as RD1, group2RC as RC2, group2RD as RD2
)
SELECT USD_rate/Eth_Rate * Eth_sum  + USD_sum as V2_Dex_Volume
from final
